{% extends "base.html" %}

{% set active_page = "backtest" %}

{% block title %}Backtest - Market Signal Lab{% endblock %}

{% block content %}
<div class="fade-in">
    <h1 class="text-2xl font-bold text-slate-100 mb-6">Backtest</h1>

    <!-- Backtest Form -->
    <div class="bg-slate-800 rounded-lg border border-slate-700 p-6 mb-6">
        <form action="/backtest" method="post"
              hx-post="/backtest"
              hx-target="#backtest-results"
              hx-select="#backtest-results"
              hx-swap="outerHTML"
              hx-indicator="#loading-indicator"
              class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="block text-xs text-slate-400 mb-1 uppercase tracking-wider">Asset</label>
                <input type="text" name="asset" placeholder="BTC-USD" required
                       value="{{ result.asset if result else '' }}"
                       class="w-full bg-slate-700 border border-slate-600 text-slate-200 text-sm rounded px-3 py-2 focus:ring-blue-500 focus:border-blue-500 placeholder-slate-500">
            </div>
            <div>
                <label class="block text-xs text-slate-400 mb-1 uppercase tracking-wider">
                    Strategy
                    <span class="group/tip relative inline-block cursor-help ml-1">
                        <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full bg-slate-600 text-[10px] text-slate-400">?</span>
                        <span class="invisible group-hover/tip:visible absolute bottom-full left-0 mb-1 px-3 py-2 text-xs text-slate-200 bg-slate-900 rounded shadow-lg w-64 normal-case z-10">
                            <strong>SMA Crossover:</strong> Buys when fast MA crosses above slow MA with volatility filter.<br>
                            <strong>RSI Mean Reversion:</strong> Buys when RSI is oversold while price is above the trend.<br>
                            <strong>Donchian Breakout:</strong> Buys when price breaks above the channel high with volume confirmation.
                        </span>
                    </span>
                </label>
                <select name="strategy"
                        class="w-full bg-slate-700 border border-slate-600 text-slate-200 text-sm rounded px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                    {% for s in strategies %}
                    <option value="{{ s }}" {% if result and result.strategy == s %}selected{% endif %}>
                        {{ s|replace('_', ' ')|title }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-xs text-slate-400 mb-1 uppercase tracking-wider">Timeframe</label>
                <select name="timeframe"
                        class="w-full bg-slate-700 border border-slate-600 text-slate-200 text-sm rounded px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="1d" {% if result and result.timeframe == '1d' %}selected{% endif %}>1 Day</option>
                    <option value="15m" {% if result and result.timeframe == '15m' %}selected{% endif %}>15 Min</option>
                </select>
            </div>
            <div>
                <label class="block text-xs text-slate-400 mb-1 uppercase tracking-wider">Start Date</label>
                <input type="date" name="start_date"
                       class="w-full bg-slate-700 border border-slate-600 text-slate-200 text-sm rounded px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label class="block text-xs text-slate-400 mb-1 uppercase tracking-wider">End Date</label>
                <input type="date" name="end_date"
                       class="w-full bg-slate-700 border border-slate-600 text-slate-200 text-sm rounded px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label class="block text-xs text-slate-400 mb-1 uppercase tracking-wider">Fee Preset</label>
                <select name="fee_preset"
                        class="w-full bg-slate-700 border border-slate-600 text-slate-200 text-sm rounded px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                    {% for fp in fee_presets %}
                    <option value="{{ fp }}" {% if result and result.fee_preset == fp %}selected{% endif %}>
                        {{ fp|replace('_', ' ')|title }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="md:col-span-3 flex items-center space-x-4">
                <button type="submit"
                        class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium px-6 py-2 rounded transition-colors">
                    Run Backtest
                </button>
                <span id="loading-indicator" class="htmx-indicator text-sm text-slate-400">
                    Running backtest...
                </span>
            </div>
        </form>
    </div>

    <!-- Error -->
    {% if error %}
    <div class="bg-red-900/30 border border-red-700 rounded-lg p-4 mb-6">
        <p class="text-sm text-red-400">{{ error }}</p>
    </div>
    {% endif %}

    <!-- Results -->
    <div id="backtest-results">
        {% if result %}
        <div class="space-y-6 fade-in">
            <!-- Metrics Summary -->
            <div class="bg-slate-800 rounded-lg border border-slate-700 p-6">
                <h2 class="text-sm font-semibold text-slate-300 uppercase tracking-wider mb-4">
                    Results: {{ result.asset }} / {{ result.strategy|replace('_', ' ')|title }} / {{ result.timeframe }}
                </h2>
                <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                    <div class="bg-slate-700/50 rounded p-3">
                        <p class="text-xs text-slate-400 uppercase">
                            CAGR
                            <span class="group/tip relative inline-block cursor-help ml-1">
                                <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full bg-slate-600 text-[10px] text-slate-400">?</span>
                                <span class="invisible group-hover/tip:visible absolute bottom-full left-1/2 -translate-x-1/2 mb-1 px-2 py-1 text-xs text-slate-200 bg-slate-900 rounded shadow-lg w-48 text-center normal-case z-10">
                                    Compound Annual Growth Rate — the average annual return if gains were compounded. Higher is better.
                                </span>
                            </span>
                        </p>
                        <p class="text-lg font-mono font-bold
                            {% if result.cagr.startswith('-') %}text-red-400{% else %}text-green-400{% endif %}">
                            {{ result.cagr }}
                        </p>
                    </div>
                    <div class="bg-slate-700/50 rounded p-3">
                        <p class="text-xs text-slate-400 uppercase">
                            Sharpe
                            <span class="group/tip relative inline-block cursor-help ml-1">
                                <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full bg-slate-600 text-[10px] text-slate-400">?</span>
                                <span class="invisible group-hover/tip:visible absolute bottom-full left-1/2 -translate-x-1/2 mb-1 px-2 py-1 text-xs text-slate-200 bg-slate-900 rounded shadow-lg w-48 text-center normal-case z-10">
                                    Risk-adjusted return — measures excess return per unit of volatility. Above 1.0 is good, above 2.0 is excellent.
                                </span>
                            </span>
                        </p>
                        <p class="text-lg font-mono font-bold text-slate-200">{{ result.sharpe }}</p>
                    </div>
                    <div class="bg-slate-700/50 rounded p-3">
                        <p class="text-xs text-slate-400 uppercase">
                            Max Drawdown
                            <span class="group/tip relative inline-block cursor-help ml-1">
                                <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full bg-slate-600 text-[10px] text-slate-400">?</span>
                                <span class="invisible group-hover/tip:visible absolute bottom-full left-1/2 -translate-x-1/2 mb-1 px-2 py-1 text-xs text-slate-200 bg-slate-900 rounded shadow-lg w-48 text-center normal-case z-10">
                                    Largest peak-to-trough decline during the backtest. Lower is better — shows worst-case loss.
                                </span>
                            </span>
                        </p>
                        <p class="text-lg font-mono font-bold text-red-400">{{ result.max_drawdown }}</p>
                    </div>
                    <div class="bg-slate-700/50 rounded p-3">
                        <p class="text-xs text-slate-400 uppercase">
                            Win Rate
                            <span class="group/tip relative inline-block cursor-help ml-1">
                                <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full bg-slate-600 text-[10px] text-slate-400">?</span>
                                <span class="invisible group-hover/tip:visible absolute bottom-full left-1/2 -translate-x-1/2 mb-1 px-2 py-1 text-xs text-slate-200 bg-slate-900 rounded shadow-lg w-48 text-center normal-case z-10">
                                    Percentage of trades that were profitable. Above 50% means more winners than losers.
                                </span>
                            </span>
                        </p>
                        <p class="text-lg font-mono font-bold text-slate-200">{{ result.win_rate }}</p>
                    </div>
                    <div class="bg-slate-700/50 rounded p-3">
                        <p class="text-xs text-slate-400 uppercase">
                            Profit Factor
                            <span class="group/tip relative inline-block cursor-help ml-1">
                                <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full bg-slate-600 text-[10px] text-slate-400">?</span>
                                <span class="invisible group-hover/tip:visible absolute bottom-full left-1/2 -translate-x-1/2 mb-1 px-2 py-1 text-xs text-slate-200 bg-slate-900 rounded shadow-lg w-48 text-center normal-case z-10">
                                    Gross profit divided by gross loss. Above 1.0 means profitable overall. Above 2.0 is strong.
                                </span>
                            </span>
                        </p>
                        <p class="text-lg font-mono font-bold text-slate-200">{{ result.profit_factor }}</p>
                    </div>
                    <div class="bg-slate-700/50 rounded p-3">
                        <p class="text-xs text-slate-400 uppercase">
                            Exposure
                            <span class="group/tip relative inline-block cursor-help ml-1">
                                <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full bg-slate-600 text-[10px] text-slate-400">?</span>
                                <span class="invisible group-hover/tip:visible absolute bottom-full left-1/2 -translate-x-1/2 mb-1 px-2 py-1 text-xs text-slate-200 bg-slate-900 rounded shadow-lg w-48 text-center normal-case z-10">
                                    Percentage of time the strategy had an open position. Lower means less market risk.
                                </span>
                            </span>
                        </p>
                        <p class="text-lg font-mono font-bold text-slate-200">{{ result.exposure }}</p>
                    </div>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                    <div class="text-sm">
                        <span class="text-slate-400">Initial Capital:</span>
                        <span class="text-slate-200 font-mono ml-1">{{ result.initial_capital }}</span>
                    </div>
                    <div class="text-sm">
                        <span class="text-slate-400">Final Equity:</span>
                        <span class="text-slate-200 font-mono ml-1">{{ result.final_equity }}</span>
                    </div>
                    <div class="text-sm">
                        <span class="text-slate-400">Total Trades:</span>
                        <span class="text-slate-200 font-mono ml-1">{{ result.total_trades }}</span>
                    </div>
                    <div class="text-sm">
                        <span class="text-slate-400">Total Bars:</span>
                        <span class="text-slate-200 font-mono ml-1">{{ result.total_bars }}</span>
                    </div>
                </div>
            </div>

            <!-- Equity Curve -->
            <div class="bg-slate-800 rounded-lg border border-slate-700 p-4">
                <div id="equity-chart" class="w-full" style="height: 350px;"></div>
                <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        renderChart('equity-chart', {{ result.equity_chart_json|safe }});
                    });
                    // Also handle HTMX swaps
                    document.addEventListener('htmx:afterSwap', function() {
                        var el = document.getElementById('equity-chart');
                        if (el) {
                            try {
                                var data = {{ result.equity_chart_json|safe }};
                                renderChart('equity-chart', data);
                            } catch(e) {}
                        }
                    });
                </script>
            </div>

            <!-- Trade List -->
            {% if result.trades %}
            <div class="bg-slate-800 rounded-lg border border-slate-700 overflow-hidden">
                <div class="px-4 py-3 border-b border-slate-700">
                    <h2 class="text-sm font-semibold text-slate-300 uppercase tracking-wider">
                        Trade History ({{ result.trades|length }} trades)
                    </h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="bg-slate-700/30 text-xs text-slate-400 uppercase tracking-wider">
                                <th class="px-3 py-2 font-medium">#</th>
                                <th class="px-3 py-2 font-medium">Entry</th>
                                <th class="px-3 py-2 font-medium">Exit</th>
                                <th class="px-3 py-2 font-medium">Entry Price</th>
                                <th class="px-3 py-2 font-medium">Exit Price</th>
                                <th class="px-3 py-2 font-medium">P&L</th>
                                <th class="px-3 py-2 font-medium">P&L %</th>
                                <th class="px-3 py-2 font-medium">Exit Reason</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for trade in result.trades %}
                            <tr class="border-t border-slate-700/50 text-sm">
                                <td class="px-3 py-2 text-slate-500">{{ loop.index }}</td>
                                <td class="px-3 py-2 text-slate-300 text-xs">{{ trade.entry_time }}</td>
                                <td class="px-3 py-2 text-slate-300 text-xs">{{ trade.exit_time }}</td>
                                <td class="px-3 py-2 font-mono text-slate-200">{{ trade.entry_price }}</td>
                                <td class="px-3 py-2 font-mono text-slate-200">{{ trade.exit_price }}</td>
                                <td class="px-3 py-2 font-mono font-medium
                                    {% if trade.pnl_positive %}text-green-400{% else %}text-red-400{% endif %}">
                                    {{ trade.pnl }}
                                </td>
                                <td class="px-3 py-2 font-mono text-xs
                                    {% if trade.pnl_positive %}text-green-400{% else %}text-red-400{% endif %}">
                                    {{ trade.pnl_pct }}
                                </td>
                                <td class="px-3 py-2 text-xs text-slate-400">{{ trade.exit_reason }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
