{% extends "base.html" %}

{% set active_page = "backtest" %}

{% block title %}Backtest - Market Signal Lab{% endblock %}

{% block content %}
<div class="fade-in">
    <h1 class="text-2xl font-bold text-slate-100 mb-6">Backtest</h1>

    <!-- Backtest Form -->
    <div class="bg-slate-800 rounded-lg border border-slate-700 p-6 mb-6">
        <form action="/backtest" method="post"
              hx-post="/backtest"
              hx-target="#backtest-results"
              hx-swap="outerHTML"
              hx-indicator="#loading-indicator"
              class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="block text-xs text-slate-400 mb-1 uppercase tracking-wider">Asset</label>
                <select name="asset" required
                        class="w-full bg-slate-700 border border-slate-600 text-slate-200 text-sm rounded px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                    {% for a in available_assets %}
                    <option value="{{ a }}" {% if result and result.asset == a %}selected{% endif %}>
                        {{ a }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-xs text-slate-400 mb-1 uppercase tracking-wider">
                    Strategy
                    <span class="group/tip relative inline-block cursor-help ml-1">
                        <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full bg-slate-600 text-[10px] text-slate-400">?</span>
                        <span class="invisible group-hover/tip:visible absolute bottom-full left-0 mb-1 px-3 py-2 text-xs text-slate-200 bg-slate-900 rounded shadow-lg w-64 normal-case z-10">
                            <strong>SMA Crossover:</strong> Buys when fast MA crosses above slow MA with volatility filter.<br>
                            <strong>RSI Mean Reversion:</strong> Buys when RSI is oversold while price is above the trend.<br>
                            <strong>Donchian Breakout:</strong> Buys when price breaks above the channel high with volume confirmation.
                        </span>
                    </span>
                </label>
                <select name="strategy"
                        class="w-full bg-slate-700 border border-slate-600 text-slate-200 text-sm rounded px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                    {% for s in strategies %}
                    <option value="{{ s }}" {% if result and result.strategy == s %}selected{% endif %}>
                        {{ s|replace('_', ' ')|title }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-xs text-slate-400 mb-1 uppercase tracking-wider">Timeframe</label>
                <select name="timeframe"
                        class="w-full bg-slate-700 border border-slate-600 text-slate-200 text-sm rounded px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="15m" {% if result and result.timeframe == '15m' %}selected{% endif %}>15 Min</option>
                    <option value="1h" {% if result and result.timeframe == '1h' %}selected{% endif %}>1 Hour</option>
                    <option value="4h" {% if result and result.timeframe == '4h' %}selected{% endif %}>4 Hours</option>
                    <option value="1d" {% if result and result.timeframe == '1d' %}selected{% endif %}>1 Day</option>
                </select>
            </div>
            <div>
                <label class="block text-xs text-slate-400 mb-1 uppercase tracking-wider">Start Date</label>
                <input type="date" name="start_date"
                       class="w-full bg-slate-700 border border-slate-600 text-slate-200 text-sm rounded px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label class="block text-xs text-slate-400 mb-1 uppercase tracking-wider">End Date</label>
                <input type="date" name="end_date"
                       class="w-full bg-slate-700 border border-slate-600 text-slate-200 text-sm rounded px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div>
                <label class="block text-xs text-slate-400 mb-1 uppercase tracking-wider">Fee Preset</label>
                <select name="fee_preset"
                        class="w-full bg-slate-700 border border-slate-600 text-slate-200 text-sm rounded px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                    {% for fp in fee_presets %}
                    <option value="{{ fp }}" {% if result and result.fee_preset == fp %}selected{% endif %}>
                        {{ fp|replace('_', ' ')|title }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-xs text-slate-400 mb-1 uppercase tracking-wider">Starting Capital</label>
                <input type="number" name="initial_capital" placeholder="10000" required
                       value="{{ initial_capital_raw|default(10000) }}" min="100" step="100"
                       class="w-full bg-slate-700 border border-slate-600 text-slate-200 text-sm rounded px-3 py-2 focus:ring-blue-500 focus:border-blue-500 placeholder-slate-500">
            </div>
            <div class="md:col-span-3 flex items-center space-x-4">
                <button type="submit"
                        class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium px-6 py-2 rounded transition-colors">
                    Run Backtest
                </button>
                {% if has_ml_model %}
                <span class="inline-flex items-center gap-1.5 text-xs text-purple-300 bg-purple-900/30 border border-purple-700/50 rounded-full px-3 py-1">
                    <span class="w-1.5 h-1.5 rounded-full bg-purple-400 animate-pulse"></span>
                    ML Model Active
                </span>
                {% endif %}
                <span id="loading-indicator" class="htmx-indicator text-sm text-slate-400">
                    Running backtest...
                </span>
            </div>
        </form>
    </div>

    <!-- Results -->
    {% include "_backtest_results.html" %}
</div>
{% endblock %}
