{% extends "base.html" %}

{% set active_page = "watchlist" %}

{% block title %}Watchlist - Market Signal Lab{% endblock %}

{% block content %}
<div class="fade-in">
    <div class="flex items-center justify-between mb-6">
        <h1 class="text-2xl font-bold text-slate-100">Watchlist</h1>
        <div class="flex items-center gap-3">
            <span id="refresh-countdown" class="text-xs text-slate-500 font-mono"></span>
            <span class="text-xs text-slate-500">
                {% set mins = (poll_interval|default(300)) // 60 %}
                {% set secs = (poll_interval|default(300)) % 60 %}
                {% if mins > 0 and secs > 0 %}
                Auto-refreshes every {{ mins }}m {{ secs }}s
                {% elif mins > 0 %}
                Auto-refreshes every {{ mins }}m
                {% else %}
                Auto-refreshes every {{ secs }}s
                {% endif %}
            </span>
        </div>
    </div>

    <!-- Add Asset Form -->
    <div class="bg-slate-800 rounded-lg border border-slate-700 p-4 mb-4">
        <form action="/watchlist/add" method="post" class="flex items-end gap-3 flex-wrap">
            <div>
                <label class="block text-xs text-slate-400 mb-1 uppercase tracking-wider">Asset</label>
                <input type="text" name="asset" list="available-assets" placeholder="BTC-USD" required
                       class="bg-slate-700 border border-slate-600 text-slate-200 text-sm rounded px-3 py-1.5 focus:ring-blue-500 focus:border-blue-500 placeholder-slate-500 w-40">
                <datalist id="available-assets">
                    {% for sym in available_assets %}
                    <option value="{{ sym }}">
                    {% endfor %}
                </datalist>
            </div>
            <div>
                <label class="block text-xs text-slate-400 mb-1 uppercase tracking-wider">Timeframe</label>
                <select name="timeframe"
                        class="bg-slate-700 border border-slate-600 text-slate-200 text-sm rounded px-3 py-1.5 focus:ring-blue-500 focus:border-blue-500">
                    <option value="1d" selected>1 Day</option>
                    <option value="4h">4 Hours</option>
                    <option value="1h">1 Hour</option>
                    <option value="15m">15 Min</option>
                </select>
            </div>
            <div>
                <label class="block text-xs text-slate-400 mb-1 uppercase tracking-wider">Type</label>
                <select name="asset_class"
                        class="bg-slate-700 border border-slate-600 text-slate-200 text-sm rounded px-3 py-1.5 focus:ring-blue-500 focus:border-blue-500">
                    <option value="crypto" selected>Crypto</option>
                    <option value="equity">Equity</option>
                </select>
            </div>
            <button type="submit"
                    class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium px-4 py-1.5 rounded transition-colors">
                Add
            </button>
        </form>
    </div>

    <div class="bg-slate-800 rounded-lg border border-slate-700 overflow-hidden">
        <table class="w-full">
            <thead>
                <tr class="bg-slate-700/50 text-xs text-slate-400 uppercase tracking-wider">
                    <th class="px-4 py-3 font-medium">Asset</th>
                    <th class="px-4 py-3 font-medium">Price</th>
                    <th class="px-4 py-3 font-medium">Last Updated</th>
                    <th class="px-4 py-3 font-medium">Active Signals</th>
                    <th class="px-4 py-3 font-medium">Strength</th>
                    <th class="px-4 py-3 font-medium w-10"></th>
                </tr>
            </thead>
            <tbody id="watchlist-body"
                   hx-get="/watchlist"
                   hx-trigger="every {{ poll_interval|default(300) }}s"
                   hx-select="#watchlist-body tr"
                   hx-swap="innerHTML">
                {% for asset in assets %}
                <tr class="border-t border-slate-700 hover:bg-slate-700/30 transition-colors cursor-pointer"
                    onclick="window.location='/asset/{{ asset.symbol }}'">
                    <td class="px-4 py-3">
                        <a href="/asset/{{ asset.symbol }}" class="text-blue-400 hover:text-blue-300 font-medium">
                            {{ asset.symbol }}
                        </a>
                    </td>
                    <td class="px-4 py-3 text-slate-200 font-mono text-sm">
                        {{ asset.price }}
                    </td>
                    <td class="px-4 py-3 text-slate-400 text-sm">
                        {{ asset.timestamp }}
                    </td>
                    <td class="px-4 py-3">
                        {% if asset.signals %}
                            {% for sig in asset.signals %}
                                <span class="inline-block text-xs font-semibold px-2 py-0.5 rounded mr-1
                                    {% if sig.signal == 'BUY' %}bg-green-900/50 text-green-400
                                    {% elif sig.signal == 'SELL' %}bg-red-900/50 text-red-400
                                    {% else %}bg-slate-700 text-slate-400{% endif %}">
                                    {{ sig.strategy|replace('_', ' ')|title }}: {{ sig.signal }}
                                </span>
                            {% endfor %}
                        {% else %}
                            <span class="text-xs text-slate-500">No signals</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3">
                        {% if asset.dominant_signal == 'BUY' %}
                            <div class="flex items-center space-x-2">
                                <div class="w-16 h-1.5 rounded-full bg-slate-700 overflow-hidden">
                                    <div class="h-full bg-green-400 rounded-full" style="width: {{ (asset.strength * 100)|int }}%"></div>
                                </div>
                                <span class="text-xs text-green-400 font-mono">{{ asset.strength }}</span>
                            </div>
                        {% elif asset.dominant_signal == 'SELL' %}
                            <div class="flex items-center space-x-2">
                                <div class="w-16 h-1.5 rounded-full bg-slate-700 overflow-hidden">
                                    <div class="h-full bg-red-400 rounded-full" style="width: {{ (asset.strength * 100)|int }}%"></div>
                                </div>
                                <span class="text-xs text-red-400 font-mono">{{ asset.strength }}</span>
                            </div>
                        {% else %}
                            <span class="text-xs text-slate-500">--</span>
                        {% endif %}
                    </td>
                    <td class="px-4 py-3 text-center">
                        <form action="/watchlist/remove" method="post" onclick="event.stopPropagation();" class="inline">
                            <input type="hidden" name="asset" value="{{ asset.symbol }}">
                            <button type="submit" title="Remove {{ asset.symbol }}"
                                    class="text-slate-500 hover:text-red-400 transition-colors text-sm">
                                &times;
                            </button>
                        </form>
                    </td>
                </tr>
                {% endfor %}

                {% if not assets %}
                <tr>
                    <td colspan="6" class="px-4 py-8 text-center text-slate-500">
                        No assets on your watchlist. Use the form above to add one.
                    </td>
                </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<script>
(function() {
    var interval = {{ poll_interval|default(300) }};
    var remaining = interval;
    var el = document.getElementById('refresh-countdown');
    if (!el) return;

    function fmt(s) {
        var m = Math.floor(s / 60);
        var sec = s % 60;
        return m > 0 ? m + ':' + (sec < 10 ? '0' : '') + sec : sec + 's';
    }

    function tick() {
        remaining--;
        if (remaining <= 0) remaining = interval;
        el.textContent = fmt(remaining);
    }

    el.textContent = fmt(remaining);
    setInterval(tick, 1000);

    // Reset countdown when HTMX swaps new content
    document.body.addEventListener('htmx:afterSwap', function(e) {
        if (e.detail.target && e.detail.target.id === 'watchlist-body') {
            remaining = interval;
        }
    });
})();
</script>
{% endblock %}
