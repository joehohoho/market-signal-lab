<div id="backtest-results">
    <!-- Error -->
    {% if error %}
    <div class="bg-red-900/30 border border-red-700 rounded-lg p-4 mb-6">
        <p class="text-sm text-red-400">{{ error }}</p>
    </div>
    {% endif %}

    <!-- ML Training Result (generic forward-return model) -->
    {% if ml_trained %}
    <div class="bg-purple-900/20 border border-purple-700 rounded-lg p-4 mb-6">
        <p class="text-sm font-medium text-purple-300">ML Model Trained — {{ ml_trained.asset }} / {{ ml_trained.timeframe }}</p>
        <div class="flex flex-wrap gap-x-4 gap-y-1 mt-2 text-xs text-slate-400">
            <span>Avg AUC: <span class="font-mono text-slate-200">{{ ml_trained.avg_auc }}</span></span>
            <span>Stable: <span class="font-mono {% if ml_trained.stable %}text-green-400{% else %}text-yellow-400{% endif %}">{{ 'Yes' if ml_trained.stable else 'No' }}</span></span>
            <span>Window AUCs: <span class="font-mono text-slate-300">{{ ml_trained.auc_scores|join(', ') }}</span></span>
        </div>
        <p class="text-xs text-slate-500 mt-1">Re-run a backtest with "ML Filter" checked to see the comparison.</p>
    </div>
    {% endif %}

    <!-- Learn & Improve Results -->
    {% if learn_result %}
    <div class="space-y-4 mb-6 fade-in">
        <!-- Learning Stats -->
        <div class="bg-gradient-to-r from-purple-900/30 to-blue-900/30 rounded-lg border border-purple-700/50 p-5">
            <h2 class="text-sm font-semibold text-purple-200 uppercase tracking-wider mb-3">
                Learning Results
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-3">
                <div class="bg-slate-800/50 rounded p-2.5">
                    <p class="text-xs text-slate-400">Trades Analysed</p>
                    <p class="text-lg font-mono font-bold text-slate-200">{{ learn_result.total_trades }}</p>
                </div>
                <div class="bg-slate-800/50 rounded p-2.5">
                    <p class="text-xs text-slate-400">Win / Loss</p>
                    <p class="text-lg font-mono font-bold">
                        <span class="text-green-400">{{ learn_result.winning_trades }}</span>
                        <span class="text-slate-500">/</span>
                        <span class="text-red-400">{{ learn_result.losing_trades }}</span>
                    </p>
                </div>
                <div class="bg-slate-800/50 rounded p-2.5">
                    <p class="text-xs text-slate-400">Validation AUC</p>
                    <p class="text-lg font-mono font-bold text-purple-300">{{ learn_result.val_auc }}</p>
                </div>
                <div class="bg-slate-800/50 rounded p-2.5">
                    <p class="text-xs text-slate-400">Validation Accuracy</p>
                    <p class="text-lg font-mono font-bold text-purple-300">{{ learn_result.val_accuracy }}</p>
                </div>
            </div>

            {% if learn_result.top_features %}
            <div class="mt-2">
                <p class="text-xs text-slate-400 uppercase tracking-wider mb-1.5">Top Predictive Features</p>
                <div class="flex flex-wrap gap-2">
                    {% for feat in learn_result.top_features %}
                    <span class="inline-flex items-center bg-slate-800/60 rounded px-2.5 py-1 text-xs">
                        <span class="text-slate-300">{{ feat.name }}</span>
                        <span class="text-purple-400 font-mono ml-1.5">{{ feat.pct }}</span>
                    </span>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Before / After Comparison -->
        <div class="bg-slate-800 rounded-lg border border-purple-700/50 p-5">
            <h2 class="text-sm font-semibold text-purple-200 uppercase tracking-wider mb-4">
                Before vs After ML Filter
                <span class="ml-2 text-xs font-normal text-slate-400">
                    {{ learn_result.trades_blocked }} trade{{ 's' if learn_result.trades_blocked != 1 else '' }} blocked
                </span>
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                {% set compare_metrics = [
                    ('CAGR', learn_result.baseline.cagr, learn_result.filtered.cagr),
                    ('Sharpe', learn_result.baseline.sharpe, learn_result.filtered.sharpe),
                    ('Max DD', learn_result.baseline.max_drawdown, learn_result.filtered.max_drawdown),
                    ('Win Rate', learn_result.baseline.win_rate, learn_result.filtered.win_rate),
                    ('Profit Factor', learn_result.baseline.profit_factor, learn_result.filtered.profit_factor),
                    ('Trades', learn_result.baseline.total_trades, learn_result.filtered.total_trades),
                    ('Final Equity', learn_result.baseline.final_equity, learn_result.filtered.final_equity),
                ] %}
                {% for label, before, after in compare_metrics %}
                <div class="bg-slate-700/30 rounded p-3">
                    <p class="text-xs text-slate-400 uppercase mb-1">{{ label }}</p>
                    <div class="flex items-baseline justify-between gap-2">
                        <span class="text-xs font-mono text-slate-500 line-through">{{ before }}</span>
                        <span class="text-sm font-mono font-bold text-purple-300">{{ after }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Comparison Equity Chart -->
            <div class="mt-4">
                <div id="comparison-chart" class="w-full" style="height: 350px;"></div>
                <script>
                    (function() {
                        var data = {{ learn_result.comparison_chart_json|safe }};
                        if (typeof renderChart === 'function') {
                            renderChart('comparison-chart', data);
                        } else {
                            document.addEventListener('DOMContentLoaded', function() {
                                renderChart('comparison-chart', data);
                            });
                        }
                    })();
                </script>
            </div>
        </div>
    </div>
    {% endif %}

    {% if result %}
    <div class="space-y-6 fade-in">
        <!-- Metrics Summary -->
        <div class="bg-slate-800 rounded-lg border border-slate-700 p-6">
            <h2 class="text-sm font-semibold text-slate-300 uppercase tracking-wider mb-4">
                Results: {{ result.asset }} / {{ result.strategy|replace('_', ' ')|title }} / {{ result.timeframe }}
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                <div class="bg-slate-700/50 rounded p-3">
                    <p class="text-xs text-slate-400 uppercase">
                        CAGR
                        <span class="group/tip relative inline-block cursor-help ml-1">
                            <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full bg-slate-600 text-[10px] text-slate-400">?</span>
                            <span class="invisible group-hover/tip:visible absolute bottom-full left-1/2 -translate-x-1/2 mb-1 px-2 py-1 text-xs text-slate-200 bg-slate-900 rounded shadow-lg w-48 text-center normal-case z-10">
                                Compound Annual Growth Rate — the average annual return if gains were compounded. Higher is better.
                            </span>
                        </span>
                    </p>
                    <p class="text-lg font-mono font-bold
                        {% if result.cagr.startswith('-') %}text-red-400{% else %}text-green-400{% endif %}">
                        {{ result.cagr }}
                    </p>
                </div>
                <div class="bg-slate-700/50 rounded p-3">
                    <p class="text-xs text-slate-400 uppercase">
                        Sharpe
                        <span class="group/tip relative inline-block cursor-help ml-1">
                            <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full bg-slate-600 text-[10px] text-slate-400">?</span>
                            <span class="invisible group-hover/tip:visible absolute bottom-full left-1/2 -translate-x-1/2 mb-1 px-2 py-1 text-xs text-slate-200 bg-slate-900 rounded shadow-lg w-48 text-center normal-case z-10">
                                Risk-adjusted return — measures excess return per unit of volatility. Above 1.0 is good, above 2.0 is excellent.
                            </span>
                        </span>
                    </p>
                    <p class="text-lg font-mono font-bold text-slate-200">{{ result.sharpe }}</p>
                </div>
                <div class="bg-slate-700/50 rounded p-3">
                    <p class="text-xs text-slate-400 uppercase">
                        Max Drawdown
                        <span class="group/tip relative inline-block cursor-help ml-1">
                            <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full bg-slate-600 text-[10px] text-slate-400">?</span>
                            <span class="invisible group-hover/tip:visible absolute bottom-full left-1/2 -translate-x-1/2 mb-1 px-2 py-1 text-xs text-slate-200 bg-slate-900 rounded shadow-lg w-48 text-center normal-case z-10">
                                Largest peak-to-trough decline during the backtest. Lower is better — shows worst-case loss.
                            </span>
                        </span>
                    </p>
                    <p class="text-lg font-mono font-bold text-red-400">{{ result.max_drawdown }}</p>
                </div>
                <div class="bg-slate-700/50 rounded p-3">
                    <p class="text-xs text-slate-400 uppercase">
                        Win Rate
                        <span class="group/tip relative inline-block cursor-help ml-1">
                            <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full bg-slate-600 text-[10px] text-slate-400">?</span>
                            <span class="invisible group-hover/tip:visible absolute bottom-full left-1/2 -translate-x-1/2 mb-1 px-2 py-1 text-xs text-slate-200 bg-slate-900 rounded shadow-lg w-48 text-center normal-case z-10">
                                Percentage of trades that were profitable. Above 50% means more winners than losers.
                            </span>
                        </span>
                    </p>
                    <p class="text-lg font-mono font-bold text-slate-200">{{ result.win_rate }}</p>
                </div>
                <div class="bg-slate-700/50 rounded p-3">
                    <p class="text-xs text-slate-400 uppercase">
                        Profit Factor
                        <span class="group/tip relative inline-block cursor-help ml-1">
                            <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full bg-slate-600 text-[10px] text-slate-400">?</span>
                            <span class="invisible group-hover/tip:visible absolute bottom-full left-1/2 -translate-x-1/2 mb-1 px-2 py-1 text-xs text-slate-200 bg-slate-900 rounded shadow-lg w-48 text-center normal-case z-10">
                                Gross profit divided by gross loss. Above 1.0 means profitable overall. Above 2.0 is strong.
                            </span>
                        </span>
                    </p>
                    <p class="text-lg font-mono font-bold text-slate-200">{{ result.profit_factor }}</p>
                </div>
                <div class="bg-slate-700/50 rounded p-3">
                    <p class="text-xs text-slate-400 uppercase">
                        Exposure
                        <span class="group/tip relative inline-block cursor-help ml-1">
                            <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full bg-slate-600 text-[10px] text-slate-400">?</span>
                            <span class="invisible group-hover/tip:visible absolute bottom-full left-1/2 -translate-x-1/2 mb-1 px-2 py-1 text-xs text-slate-200 bg-slate-900 rounded shadow-lg w-48 text-center normal-case z-10">
                                Percentage of time the strategy had an open position. Lower means less market risk.
                            </span>
                        </span>
                    </p>
                    <p class="text-lg font-mono font-bold text-slate-200">{{ result.exposure }}</p>
                </div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-4">
                <div class="text-sm">
                    <span class="text-slate-400">Initial Capital:</span>
                    <span class="text-slate-200 font-mono ml-1">{{ result.initial_capital }}</span>
                </div>
                <div class="text-sm">
                    <span class="text-slate-400">Final Equity:</span>
                    <span class="text-slate-200 font-mono ml-1">{{ result.final_equity }}</span>
                </div>
                <div class="text-sm">
                    <span class="text-slate-400">Total Trades:</span>
                    <span class="text-slate-200 font-mono ml-1">{{ result.total_trades }}</span>
                </div>
                <div class="text-sm">
                    <span class="text-slate-400">Total Bars:</span>
                    <span class="text-slate-200 font-mono ml-1">{{ result.total_bars }}</span>
                </div>
            </div>
        </div>

        <!-- Learn & Improve Button -->
        {% if not learn_result %}
        <div class="bg-gradient-to-r from-purple-900/30 to-blue-900/30 rounded-lg border border-purple-700/50 p-5">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-semibold text-purple-200">Learn & Improve</p>
                    <p class="text-xs text-slate-400 mt-1">
                        Train an ML model from this backtest's trade outcomes. The model learns which BUY signals
                        lead to profitable trades and blocks the ones that look like past losers.
                    </p>
                </div>
                <form action="/backtest/learn" method="post" onsubmit="(function(f){var b=f.querySelector('button');b.disabled=true;b.innerHTML='<svg class=\'animate-spin inline-block w-4 h-4 mr-2 -mt-0.5\' xmlns=\'http://www.w3.org/2000/svg\' fill=\'none\' viewBox=\'0 0 24 24\'><circle class=\'opacity-25\' cx=\'12\' cy=\'12\' r=\'10\' stroke=\'currentColor\' stroke-width=\'4\'></circle><path class=\'opacity-75\' fill=\'currentColor\' d=\'M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z\'></path></svg>Training\u2026';b.classList.remove('hover:bg-purple-700');b.classList.add('opacity-75','cursor-wait');})(this);">
                    <input type="hidden" name="asset" value="{{ result.asset }}">
                    <input type="hidden" name="strategy" value="{{ result.strategy }}">
                    <input type="hidden" name="timeframe" value="{{ result.timeframe }}">
                    <input type="hidden" name="fee_preset" value="{{ result.fee_preset }}">
                    <input type="hidden" name="initial_capital" value="{{ initial_capital_raw|default(10000) }}">
                    <button type="submit"
                            class="bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium px-5 py-2 rounded transition-colors whitespace-nowrap">
                        Learn & Improve
                    </button>
                </form>
            </div>
        </div>
        {% endif %}

        <!-- Equity Curve -->
        <div class="bg-slate-800 rounded-lg border border-slate-700 p-4">
            <div id="equity-chart" class="w-full" style="height: 350px;"></div>
            <script>
                (function() {
                    var data = {{ result.equity_chart_json|safe }};
                    if (typeof renderChart === 'function') {
                        renderChart('equity-chart', data);
                    } else {
                        document.addEventListener('DOMContentLoaded', function() {
                            renderChart('equity-chart', data);
                        });
                    }
                })();
            </script>
        </div>

        <!-- ML Comparison -->
        {% if ml_result %}
        <div class="bg-slate-800 rounded-lg border border-purple-700/50 p-6">
            <h2 class="text-sm font-semibold text-purple-300 uppercase tracking-wider mb-4">
                ML-Filtered Comparison
                <span class="ml-2 text-xs font-normal text-slate-400">
                    {{ ml_result.trades_blocked }} trade{{ 's' if ml_result.trades_blocked != 1 else '' }} blocked by ML filter
                </span>
            </h2>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                {% set metrics = [
                    ('CAGR', result.cagr, ml_result.cagr),
                    ('Sharpe', result.sharpe, ml_result.sharpe),
                    ('Max DD', result.max_drawdown, ml_result.max_drawdown),
                    ('Win Rate', result.win_rate, ml_result.win_rate),
                    ('Profit Factor', result.profit_factor, ml_result.profit_factor),
                    ('Trades', result.total_trades, ml_result.total_trades),
                    ('Final Equity', result.final_equity, ml_result.final_equity),
                ] %}
                {% for label, baseline, filtered in metrics %}
                <div class="bg-slate-700/30 rounded p-3">
                    <p class="text-xs text-slate-400 uppercase mb-1">{{ label }}</p>
                    <div class="flex items-baseline justify-between">
                        <span class="text-sm font-mono text-slate-400 line-through">{{ baseline }}</span>
                        <span class="text-sm font-mono font-bold text-purple-300">{{ filtered }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- ML Equity Curve -->
            <div class="mt-4">
                <div id="ml-equity-chart" class="w-full" style="height: 300px;"></div>
                <script>
                    (function() {
                        var data = {{ ml_result.equity_chart_json|safe }};
                        if (typeof renderChart === 'function') {
                            renderChart('ml-equity-chart', data);
                        } else {
                            document.addEventListener('DOMContentLoaded', function() {
                                renderChart('ml-equity-chart', data);
                            });
                        }
                    })();
                </script>
            </div>
        </div>
        {% endif %}

        <!-- Trade List -->
        {% if result.trades %}
        <div class="bg-slate-800 rounded-lg border border-slate-700 overflow-hidden">
            <div class="px-4 py-3 border-b border-slate-700">
                <h2 class="text-sm font-semibold text-slate-300 uppercase tracking-wider">
                    Trade History ({{ result.trades|length }} trades)
                </h2>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr class="bg-slate-700/30 text-xs text-slate-400 uppercase tracking-wider">
                            <th class="px-3 py-2 font-medium">#</th>
                            <th class="px-3 py-2 font-medium">Entry</th>
                            <th class="px-3 py-2 font-medium">Exit</th>
                            <th class="px-3 py-2 font-medium">Entry Price</th>
                            <th class="px-3 py-2 font-medium">Exit Price</th>
                            <th class="px-3 py-2 font-medium">P&L</th>
                            <th class="px-3 py-2 font-medium">P&L %</th>
                            <th class="px-3 py-2 font-medium">Exit Reason</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for trade in result.trades %}
                        <tr class="border-t border-slate-700/50 text-sm">
                            <td class="px-3 py-2 text-slate-500">{{ loop.index }}</td>
                            <td class="px-3 py-2 text-slate-300 text-xs">{{ trade.entry_time }}</td>
                            <td class="px-3 py-2 text-slate-300 text-xs">{{ trade.exit_time }}</td>
                            <td class="px-3 py-2 font-mono text-slate-200">{{ trade.entry_price }}</td>
                            <td class="px-3 py-2 font-mono text-slate-200">{{ trade.exit_price }}</td>
                            <td class="px-3 py-2 font-mono font-medium
                                {% if trade.pnl_positive %}text-green-400{% else %}text-red-400{% endif %}">
                                {{ trade.pnl }}
                            </td>
                            <td class="px-3 py-2 font-mono text-xs
                                {% if trade.pnl_positive %}text-green-400{% else %}text-red-400{% endif %}">
                                {{ trade.pnl_pct }}
                            </td>
                            <td class="px-3 py-2 text-xs text-slate-400">{{ trade.exit_reason }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div>
    {% endif %}
</div>
