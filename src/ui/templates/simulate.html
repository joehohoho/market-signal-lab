{% extends "base.html" %}

{% set active_page = "simulate" %}

{% block title %}Simulate - Market Signal Lab{% endblock %}

{% block content %}
<div class="fade-in">
    <h1 class="text-2xl font-bold text-slate-100 mb-6">Paper Trading Scenarios</h1>

    <!-- Create New Scenario -->
    <div class="bg-slate-800 rounded-lg border border-slate-700 p-6 mb-6">
        <h2 class="text-sm font-semibold text-slate-300 uppercase tracking-wider mb-4">Create New Scenario</h2>
        <form action="/simulate/create" method="post"
              class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
                <label class="block text-xs text-slate-400 mb-1 uppercase tracking-wider">Asset</label>
                <input type="text" name="asset" placeholder="BTC-USD" required
                       class="w-full bg-slate-700 border border-slate-600 text-slate-200 text-sm rounded px-3 py-2 focus:ring-blue-500 focus:border-blue-500 placeholder-slate-500">
            </div>
            <div>
                <label class="block text-xs text-slate-400 mb-1 uppercase tracking-wider">
                    Strategy
                    <span class="group/tip relative inline-block cursor-help ml-1">
                        <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full bg-slate-600 text-[10px] text-slate-400">?</span>
                        <span class="invisible group-hover/tip:visible absolute bottom-full left-0 mb-1 px-3 py-2 text-xs text-slate-200 bg-slate-900 rounded shadow-lg w-64 normal-case z-10">
                            <strong>SMA Crossover:</strong> Buys when fast MA crosses above slow MA with volatility filter.<br>
                            <strong>RSI Mean Reversion:</strong> Buys when RSI is oversold while price is above the trend.<br>
                            <strong>Donchian Breakout:</strong> Buys when price breaks above the channel high with volume confirmation.
                        </span>
                    </span>
                </label>
                <select name="strategy"
                        class="w-full bg-slate-700 border border-slate-600 text-slate-200 text-sm rounded px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                    {% for s in strategies %}
                    <option value="{{ s }}">{{ s|replace('_', ' ')|title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-xs text-slate-400 mb-1 uppercase tracking-wider">Starting Capital</label>
                <input type="number" name="capital" placeholder="10000" required
                       value="10000" min="100" step="100"
                       class="w-full bg-slate-700 border border-slate-600 text-slate-200 text-sm rounded px-3 py-2 focus:ring-blue-500 focus:border-blue-500 placeholder-slate-500">
            </div>
            <div>
                <label class="block text-xs text-slate-400 mb-1 uppercase tracking-wider">Timeframe</label>
                <select name="timeframe"
                        class="w-full bg-slate-700 border border-slate-600 text-slate-200 text-sm rounded px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="15m">15 Min</option>
                    <option value="1h">1 Hour</option>
                    <option value="4h">4 Hours</option>
                    <option value="1d" selected>1 Day</option>
                </select>
            </div>
            <div>
                <label class="block text-xs text-slate-400 mb-1 uppercase tracking-wider">
                    Duration
                    <span class="group/tip relative inline-block cursor-help ml-1">
                        <span class="inline-flex items-center justify-center w-3.5 h-3.5 rounded-full bg-slate-600 text-[10px] text-slate-400">?</span>
                        <span class="invisible group-hover/tip:visible absolute bottom-full left-1/2 -translate-x-1/2 mb-1 px-2 py-1 text-xs text-slate-200 bg-slate-900 rounded shadow-lg w-48 text-center normal-case z-10">
                            How long to run this test. The strategy will trade with real market data during this period.
                        </span>
                    </span>
                </label>
                <select name="duration"
                        class="w-full bg-slate-700 border border-slate-600 text-slate-200 text-sm rounded px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                    <option value="7">7 Days</option>
                    <option value="14">14 Days</option>
                    <option value="30" selected>30 Days</option>
                    <option value="60">60 Days</option>
                    <option value="90">90 Days</option>
                </select>
            </div>
            <div>
                <label class="block text-xs text-slate-400 mb-1 uppercase tracking-wider">Fee Preset</label>
                <select name="fee_preset"
                        class="w-full bg-slate-700 border border-slate-600 text-slate-200 text-sm rounded px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                    {% for fp in fee_presets %}
                    <option value="{{ fp }}">{{ fp|replace('_', ' ')|title }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="md:col-span-3">
                <button type="submit"
                        class="bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium px-6 py-2 rounded transition-colors">
                    Start Scenario
                </button>
            </div>
        </form>
    </div>

    <!-- Error -->
    {% if error %}
    <div class="bg-red-900/30 border border-red-700 rounded-lg p-4 mb-6">
        <p class="text-sm text-red-400">{{ error }}</p>
    </div>
    {% endif %}

    <!-- Scenario List -->
    {% if scenarios %}
    <div class="space-y-3">
        {% for sc in scenarios %}
        <div class="bg-slate-800 rounded-lg border border-slate-700 p-4 flex items-center justify-between">
            <a href="/simulate/{{ sc.id }}" class="flex-1 flex items-center space-x-4 hover:opacity-80 transition-opacity">
                <div class="flex-1">
                    <div class="flex items-center space-x-3">
                        <span class="text-lg font-bold text-slate-100">{{ sc.asset }}</span>
                        <span class="text-sm text-slate-400">{{ sc.strategy_fmt }}</span>
                        <span class="text-sm font-mono text-slate-400">{{ sc.capital_fmt }}</span>
                        <span class="text-xs px-2 py-0.5 rounded-full font-medium
                            {% if sc.is_expired %}bg-slate-600 text-slate-300
                            {% else %}bg-green-900/50 text-green-400 border border-green-700{% endif %}">
                            {% if sc.is_expired %}Expired{% else %}Active — {{ sc.days_remaining }}d left{% endif %}
                        </span>
                    </div>
                    <p class="text-xs text-slate-500 mt-1">
                        Created {{ sc.created_fmt }} · {{ sc.duration_days }} day test · {{ sc.timeframe }}
                    </p>
                </div>
                <span class="text-slate-500 text-sm">View →</span>
            </a>
            <form action="/simulate/{{ sc.id }}/delete" method="post" class="ml-4"
                  onsubmit="return confirm('Delete this scenario?')">
                <button type="submit"
                        class="text-xs text-red-400 hover:text-red-300 px-2 py-1 rounded border border-red-800 hover:border-red-600 transition-colors">
                    Delete
                </button>
            </form>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="bg-slate-800/50 rounded-lg border border-slate-700 p-8 text-center">
        <p class="text-slate-400">No scenarios yet. Create one above to start testing a strategy with real market data.</p>
    </div>
    {% endif %}
</div>
{% endblock %}
